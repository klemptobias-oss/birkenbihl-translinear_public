<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Werkseite</title>

    <!-- Basis-Stile -->
    <link rel="stylesheet" href="style.css" />
    <!-- Werk-spezifisches Layout -->
    <link rel="stylesheet" href="work.css" />
  </head>
  <body>
    <!-- ======= Kopf ======= -->
    <header class="topbar">
      <div class="topbar-left">
        <a class="back-link" href="index.html">← Zurück zur Startseite</a>
      </div>
      <div class="topbar-center">
        <h1 id="pageTitle" class="page-title">Autor – Werk</h1>
      </div>
      <div class="topbar-right"></div>
    </header>

    <main class="wrap">
      <!-- ======= 2×2-Grid ======= -->
      <section class="grid-2x2">
        <!-- Original-Text (oben links) -->
        <div class="pane">
          <div class="pane-head">
            <div class="pane-title">Original.txt</div>
            <div class="pane-tools">
              <button id="btnOrigPlus" class="btn" title="Schrift größer">
                A+
              </button>
              <button id="btnOrigMinus" class="btn" title="Schrift kleiner">
                A−
              </button>
              <button id="btnOrigDownload" class="btn primary">
                Original.txt herunterladen
              </button>
            </div>
          </div>
          <div id="origText" class="pane-body mono scroll"></div>
        </div>

        <!-- PDF (oben rechts) -->
        <div class="pane pdf-pane">
          <div class="pane-head">
            <div class="pane-title">PDF-Ansicht</div>
            <div class="pane-tools">
              <button class="btn" id="pdfOpenTabBtn">
                PDF in neuem Tab öffnen
              </button>
              <button class="btn primary" id="pdfDownloadBtn">
                Aktuelles PDF herunterladen
              </button>
            </div>
          </div>
          <div class="pane-body pdf-body">
            <!-- PDF-Renderer direkt im PDF-Fenster -->
            <div class="pdf-renderer-container" id="pdfRendererContainer">
              <!-- PDF-Toolbar -->
              <div class="pdf-toolbar" id="pdfToolbar">
                <!-- Navigation-Zeile: Seite links, Zoom Mitte, Source rechts -->
                <div class="pdf-toolbar-row pdf-nav-row">
                  <div class="pdf-nav-left">
                    <button class="btn" id="pdfPrev">⟨</button>
                    <div>
                      <span id="pdfPageLabel">Seite</span>
                      <strong id="pdfPageNum">–</strong>/<span id="pdfPageCount"
                        >–</span
                      >
                    </div>
                    <button class="btn" id="pdfNext">⟩</button>
                  </div>
                  <div class="pdf-source-controls">
                    <div class="pdf-options-group">
                      <button
                        class="pdf-option-btn active"
                        data-opt="source"
                        data-val="original"
                      >
                        Original
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="source"
                        data-val="draft"
                      >
                        Entwurf
                      </button>
                    </div>
                  </div>
                </div>

                <!-- PDF-Toolbar - Zeile 2: PDF-Optionen -->
                <div class="pdf-toolbar-row pdf-options-row">
                  <div class="pdf-options-integrated">
                    <div class="pdf-options-group">
                      <button
                        class="pdf-option-btn active"
                        data-opt="strength"
                        data-val="Normal"
                      >
                        Normal
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="strength"
                        data-val="GR_Fett"
                      >
                        Fett
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="strength"
                        data-val="DE_Fett"
                      >
                        DE-Fett
                      </button>
                    </div>

                    <div class="pdf-options-group">
                      <button
                        class="pdf-option-btn active"
                        data-opt="color"
                        data-val="Colour"
                      >
                        Colour
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="color"
                        data-val="BlackWhite"
                      >
                        BlackWhite
                      </button>
                    </div>

                    <div class="pdf-options-group">
                      <button
                        class="pdf-option-btn active"
                        data-opt="tags"
                        data-val="Tag"
                      >
                        Tags
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="tags"
                        data-val="NoTags"
                      >
                        NoTag
                      </button>
                    </div>

                    <div class="pdf-options-group">
                      <button
                        class="pdf-option-btn active"
                        data-opt="meter"
                        data-val="with"
                      >
                        Versmaß
                      </button>
                      <button
                        class="pdf-option-btn"
                        data-opt="meter"
                        data-val="without"
                      >
                        Ohne Versmaß
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PDF-Seiten -->
              <div class="pdf-pages" id="pdfPages">
                <div class="pdf-loading">
                  <div class="pdf-spinner"></div>
                  PDF wird geladen...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Birkenbihl-Text (unten links) -->
        <div class="pane">
          <div class="pane-head">
            <div class="pane-title">Original-Birkenbihl.txt</div>
            <div class="pane-tools">
              <button id="btnBirkenbihlDownload" class="btn primary">
                Birkenbihl.txt herunterladen
              </button>
            </div>
          </div>
          <!-- Zweite Header-Zeile -->
          <div class="pane-head">
            <div class="pane-title"></div>
            <div class="pane-tools">
              <button
                id="toggleBirkenbihlTags"
                class="toggle-btn"
                data-state="on"
                title="Grammatik-Tags im Editor ein-/ausblenden"
              >
                Grammatik-Tags anzeigen
                <span class="toggle-status green">An</span>
              </button>
              <button
                id="toggleBirkenbihlMetrum"
                class="toggle-btn"
                data-state="on"
                title="Metrum-Marker ein-/ausblenden"
              >
                Metrum-Marker anzeigen
                <span class="toggle-status green">An</span>
              </button>
              <button id="btnBirPlus" class="btn" title="Schrift größer">
                A+
              </button>
              <button id="btnBirMinus" class="btn" title="Schrift kleiner">
                A−
              </button>
            </div>
          </div>
          <div id="birkenbihlText" class="pane-body mono"></div>
        </div>

        <!-- Entwurf → PDF (unten rechts) -->
        <div class="pane">
          <div class="pane-head">
            <div class="pane-title">Entwurf → PDF</div>
            <div class="pane-tools">
              <button id="draftFileLabel" class="btn primary">
                Entwurf.txt hochladen
              </button>
              <button id="btnDraftDownload" class="btn primary">
                Entwurf.txt herunterladen
              </button>
              <button id="btnRenderDraft" class="btn primary">
                PDF aus Entwurf erstellen
              </button>
            </div>
          </div>
          <!-- Zweite Header-Zeile -->
          <div class="pane-head">
            <div class="pane-title"></div>
            <div class="pane-tools">
              <button
                id="toggleDraftTags"
                class="toggle-btn"
                data-state="on"
                title="Grammatik-Tags im Editor ein-/ausblenden"
              >
                Grammatik-Tags anzeigen
                <span class="toggle-status green">An</span>
              </button>
              <button
                id="toggleDraftMetrum"
                class="toggle-btn"
                data-state="on"
                title="Metrum-Marker ein-/ausblenden"
              >
                Metrum-Marker anzeigen
                <span class="toggle-status green">An</span>
              </button>
              <button id="btnDraftTextPlus" class="btn" title="Schrift größer">
                A+
              </button>
              <button
                id="btnDraftTextMinus"
                class="btn"
                title="Schrift kleiner"
              >
                A−
              </button>
              <button id="resetDraft" class="btn" title="Entwurf zurücksetzen">
                Entwurf zurücksetzen
              </button>
            </div>
          </div>
          <input
            id="draftFile"
            type="file"
            accept=".txt"
            style="display: none"
          />

          <div
            id="draftText"
            class="pane-body mono"
            contenteditable="true"
          ></div>
        </div>
      </section>
    </main>

    <!-- Reset Draft Confirmation Modal -->
    <div id="resetDraftModal" class="modal" style="display: none">
      <div class="modal-content confirmation-modal">
        <div class="modal-header">
          <h2>Entwurf zurücksetzen</h2>
          <button id="closeResetModal" class="btn">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Wenn Sie auf “Entwurf zurücksetzen” klicken, wird Ihr aktueller
            Entwurf gelöscht und der originale Entwurf wiederhergestellt. Sie
            können Ihren Entwurf herunterladen, falls Sie ihn lieber speichern
            wollen und ihn später wieder hochladen.
          </p>
          <p><strong>Wollen Sie mit dem Zurücksetzen fortfahren?</strong></p>
        </div>
        <div class="modal-footer">
          <button id="cancelReset" class="btn">Abbrechen</button>
          <button id="confirmReset" class="btn primary">
            Entwurf zurücksetzen
          </button>
        </div>
      </div>
    </div>

    <!-- Rendering-Modal -->
    <div id="renderingModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>PDF-Rendering konfigurieren</h2>
          <div class="header-controls">
            <button id="toggleAllColors" class="btn toggle-btn" data-state="on">
              <span class="toggle-text">Originale Farben</span>
              <span class="toggle-status green">An</span>
            </button>
            <button
              id="toggleAllTagsHidden"
              class="btn toggle-btn"
              data-state="off"
            >
              <span class="toggle-text">Alle Tags verstecken</span>
              <span class="toggle-status red">Aus</span>
            </button>
          </div>
          <button id="closeModal" class="btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="config-section">
            <h3>Tag- und Farbkonfiguration</h3>
            <p class="config-hint">
              Hinweis: Die originale Tag- und Farbkonfiguration ist
              voreingestellt. Innerhalb einer Gruppe (z.B. Verben) überschreiben
              die weiter unten liegenden Farbeinstellungen die darüberliegenden.
              Beispiel: Die Tempora in der Gruppe Verben werden auf grün
              eingestellt. Das Aktiv in der Gruppe Verben ist aber rot
              eingestellt. Dann erscheinen Verben grün, Verben mit Aktiv-Tag
              aber rot. Es wird immer zu dem von Ihnen konfigurierten PDF die
              _BlackWhite, _NoTags, _Tags, _Colour, _GR-Fett, _DE-Fett und
              _Normal Version zusätzlich erzeugt. Das Erstellen der PDFs kann
              bis zu 60 Sekunden dauern.
            </p>
            <div class="tag-table-container">
              <div id="tag-config-tables">
                <!-- Hier werden die einzelnen Gruppentabellen dynamisch erstellt -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancelRendering" class="btn">Abbrechen</button>
          <button id="confirmRendering" class="btn primary">
            PDFs erstellen
          </button>
        </div>
      </div>
    </div>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      // PDF.js Worker konfigurieren
      window["pdfjs-dist/build/pdf"].GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>

    <!-- Globale Utils -->
    <script src="utils.js"></script>
    <!-- Worker-Basis für Draft-Render -->
    <script>
      window.WORKER_BASE =
        "https://birkenbihl-draft-01.klemp-tobias.workers.dev";
    </script>
    <!-- Hauptlogik (deine vorhandene Datei) -->
    <script type="module" src="work.js"></script>

    <!-- Kleines Patch-Skript: Titel säubern, PDF-Links & Zoom -->
    <script>
      (function () {
        function cleanTitle() {
          const h = document.getElementById("pageTitle");
          if (!h) return;
          h.textContent = h.textContent.replace(/_/g, " ");
        }

        // PDF-Links aktualisieren, wenn sich die Iframe-Quelle ändert
        function hookPdfLinks() {
          const iframe = document.getElementById("pdfFrame");
          const dl = document.getElementById("btnPdfDownload");
          const open = document.getElementById("btnPdfOpenTab");
          if (!iframe || !dl || !open) return;

          const update = () => {
            const src = iframe.getAttribute("src") || "#";
            dl.href = src;
            // Dateiname aus dem Pfad ziehen
            try {
              const nm = src.split("/").pop() || "auswahl.pdf";
              dl.setAttribute("download", nm);
            } catch {}
            open.onclick = (e) => {
              e.preventDefault();
              if (src && src !== "#") window.open(src, "_blank");
            };
          };

          // sofort & bei Änderungen aktualisieren
          update();
          const mo = new MutationObserver(update);
          mo.observe(iframe, { attributes: true, attributeFilter: ["src"] });

          // Auch bei Klicks auf die Optionen absichern
          document.addEventListener("click", (ev) => {
            const t = ev.target;
            if (t && t.classList && t.classList.contains("seg-btn")) {
              setTimeout(update, 0);
            }
          });
        }

        // Text-Zoom-Funktionalität
        function setupTextZoom() {
          function makeTextZoom(textId, plusBtnId, minusBtnId) {
            const textElement = document.getElementById(textId);
            const plus = document.getElementById(plusBtnId);
            const minus = document.getElementById(minusBtnId);
            if (!textElement || !plus || !minus) return;

            let fontSize = 14; // Standard-Schriftgröße
            const apply = () => (textElement.style.fontSize = fontSize + "px");

            plus.addEventListener("click", () => {
              fontSize = Math.min(24, fontSize + 2);
              apply();
            });

            minus.addEventListener("click", () => {
              fontSize = Math.max(10, fontSize - 2);
              apply();
            });

            apply(); // Initial anwenden
          }

          makeTextZoom("origText", "btnOrigPlus", "btnOrigMinus");
          makeTextZoom("birkenbihlText", "btnBirPlus", "btnBirMinus");
          makeTextZoom("draftText", "btnDraftTextPlus", "btnDraftTextMinus");
        }

        // Download-Button-Funktionalität wird in work.js gehandhabt
        function setupDownloadButtons() {
          // Die Download-Buttons werden in work.js initialisiert
          // Hier nur Platzhalter für zukünftige Erweiterungen
        }

        document.addEventListener("DOMContentLoaded", () => {
          cleanTitle();
          hookPdfLinks();
          setupTextZoom();
          setupDownloadButtons();

          // SUPER EINFACHE LÖSUNG: Beide unteren Text-Fenster gleich groß machen
          setTimeout(() => {
            const birkenbihlText = document.getElementById("birkenbihlText");
            const draftText = document.getElementById("draftText");

            if (birkenbihlText) {
              birkenbihlText.style.height = "800px";
              birkenbihlText.style.maxHeight = "800px";
              birkenbihlText.style.minHeight = "800px";
              birkenbihlText.style.overflowY = "auto";
              birkenbihlText.style.display = "block";
              birkenbihlText.style.flex = "none";
              console.log("Birkenbihl-Fenster auf 800px gesetzt!");
            }

            if (draftText) {
              draftText.style.height = "800px";
              draftText.style.maxHeight = "800px";
              draftText.style.minHeight = "800px";
              draftText.style.overflowY = "auto";
              draftText.style.display = "block";
              draftText.style.flex = "none";
              console.log("Entwurf-Fenster auf 800px gesetzt!");
            }
          }, 100);
        });
      })();
    </script>
  </body>
</html>
