<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Werkseite</title>

    <!-- Basis-Stile -->
    <link rel="stylesheet" href="style.css" />
    <!-- Werk-spezifisches Layout -->
    <link rel="stylesheet" href="work.css" />
  </head>
  <body>
    <!-- ======= Kopf ======= -->
    <header class="topbar">
      <div class="topbar-left">
        <a class="back-link" href="index.html">← Zurück zur Startseite</a>
      </div>
      <div class="topbar-center">
        <h1 id="pageTitle" class="page-title">Autor – Werk</h1>
      </div>
      <div class="topbar-right"></div>
    </header>

    <main class="wrap">
      <div class="notice small">
        (Hinweis für Redaktion) Diese Werkseite lädt per URL-Parametern
        <code>?kind=&amp;author=&amp;work=</code>.
      </div>

      <!-- ======= 2×2-Grid ======= -->
      <section class="grid-2x2">
        <!-- Original-Text (oben links) -->
        <div class="pane">
          <div class="pane-head">
            <div class="pane-title">Original-Text</div>
            <div class="pane-tools">
              <button id="btnOrigPlus" class="btn" title="Schrift größer">
                A+
              </button>
              <button id="btnOrigMinus" class="btn" title="Schrift kleiner">
                A−
              </button>
              <a id="btnOrigDownload" class="btn primary" href="#" download
                >Original.txt herunterladen</a
              >
            </div>
          </div>
          <div id="origText" class="pane-body mono scroll"></div>
        </div>

        <!-- PDF (oben rechts) -->
        <div class="pane">
          <div class="pane-head">
            <div class="pane-title">PDF</div>
            <div class="pane-tools">
              <button
                id="btnPdfOpenTab"
                class="btn"
                title="In neuem Tab öffnen"
              >
                PDF in neuem Tab öffnen
              </button>
              <a id="btnPdfDownload" class="btn primary" href="#" download
                >Aktuelles PDF herunterladen</a
              >
            </div>
          </div>

          <!-- Schalter: Quelle / Stärke / Farbe / Tags / Versmaß -->
          <div class="option-groups">
            <div class="opt-row">
              <div class="opt-label">Quelle</div>
              <div class="seg">
                <button class="seg-btn" data-opt="source" data-val="original">
                  Original
                </button>
                <button class="seg-btn" data-opt="source" data-val="draft">
                  Entwurf
                </button>
              </div>
            </div>

            <div class="opt-row">
              <div class="opt-label">Stärke</div>
              <div class="seg" id="seg-strength">
                <button class="seg-btn" data-opt="strength" data-val="Normal">
                  Normal
                </button>
                <button class="seg-btn" data-opt="strength" data-val="GR_Fett">
                  Fett
                </button>
                <button class="seg-btn" data-opt="strength" data-val="DE_Fett">
                  DE-Fett
                </button>
              </div>
            </div>

            <div class="opt-row">
              <div class="opt-label">Farbe</div>
              <div class="seg">
                <button class="seg-btn" data-opt="color" data-val="Colour">
                  Colour
                </button>
                <button class="seg-btn" data-opt="color" data-val="BlackWhite">
                  BlackWhite
                </button>
              </div>
            </div>

            <div class="opt-row">
              <div class="opt-label">Grammatik-Tags</div>
              <div class="seg">
                <button class="seg-btn" data-opt="tags" data-val="Tag">
                  Tags
                </button>
                <button class="seg-btn" data-opt="tags" data-val="NoTags">
                  NoTag
                </button>
              </div>
            </div>

            <div class="opt-row" id="opt-meter-row">
              <div class="opt-label">Versmaß</div>
              <div class="seg">
                <button class="seg-btn" data-opt="meter" data-val="with">
                  Versmaß
                </button>
                <button class="seg-btn" data-opt="meter" data-val="without">
                  Ohne Versmaß
                </button>
              </div>
            </div>
          </div>

          <div class="pane-body pdf-body" id="pdfPane" style="--pdfScale: 1">
            <iframe id="pdfFrame" title="PDF-Ansicht" loading="lazy"></iframe>
          </div>
        </div>

        <!-- Birkenbihl-Text (unten links) -->
        <div class="pane">
          <div class="pane-head complex-header">
            <div class="header-row">
              <div class="pane-title">Original Birkenbihl-Text</div>
              <a
                id="btnBirkenbihlDownload"
                class="btn primary"
                href="#"
                download
                >Birkenbihl.txt herunterladen</a
              >
            </div>
            <div class="header-separator"></div>
            <div class="header-row">
              <div class="display-controls">
                <button
                  id="toggleBirkenbihlTags"
                  class="btn toggle-btn"
                  data-state="on"
                  title="Grammatik-Tags im Editor ein-/ausblenden"
                >
                  <span class="toggle-text">Tags im Editor sichtbar</span>
                  <span class="toggle-status green">An</span>
                </button>
                <button id="btnBirPlus" class="btn" title="Schrift größer">
                  A+
                </button>
                <button id="btnBirMinus" class="btn" title="Schrift kleiner">
                  A−
                </button>
              </div>
            </div>
          </div>
          <div id="birkenbihlText" class="pane-body mono"></div>
        </div>

        <!-- Entwurf → PDF (unten rechts) -->
        <div class="pane">
          <div class="pane-head complex-header">
            <div class="header-row">
              <div class="pane-title">Entwurf → PDF</div>
              <a id="btnDraftDownload" class="btn primary" href="#" download
                >Entwurf.txt herunterladen</a
              >
            </div>
            <div class="header-row">
              <button id="btnRenderDraft" class="btn primary">
                PDF aus Entwurf rendern
              </button>
              <label for="draftFile" id="draftFileLabel" class="btn primary"
                >Entwurf.txt hochladen</label
              >
              <input
                id="draftFile"
                type="file"
                accept=".txt"
                class="visually-hidden"
              />
            </div>
            <div class="header-separator"></div>
            <div class="header-row">
              <div class="display-controls">
                <button
                  id="toggleDraftTags"
                  class="btn toggle-btn"
                  data-state="on"
                  title="Grammatik-Tags im Editor ein-/ausblenden"
                >
                  <span class="toggle-text">Tags im Editor sichtbar</span>
                  <span class="toggle-status green">An</span>
                </button>
                <button
                  id="btnDraftTextPlus"
                  class="btn"
                  title="Schrift größer"
                >
                  A+
                </button>
                <button
                  id="btnDraftTextMinus"
                  class="btn"
                  title="Schrift kleiner"
                >
                  A−
                </button>
              </div>
              <button id="resetDraft" class="btn" title="Entwurf zurücksetzen">
                Entwurf zurücksetzen
              </button>
            </div>
          </div>

          <div class="draft-uploader">
            <span class="muted" id="draftStatus">Bereit.</span>
          </div>

          <div
            id="draftText"
            class="pane-body mono"
            contenteditable="true"
          ></div>
        </div>
      </section>
    </main>

    <!-- Reset Draft Confirmation Modal -->
    <div id="resetDraftModal" class="modal" style="display: none">
      <div class="modal-content confirmation-modal">
        <div class="modal-header">
          <h2>Entwurf zurücksetzen</h2>
          <button id="closeResetModal" class="btn">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Wenn Sie auf “Entwurf zurücksetzen” klicken, wird Ihr aktueller
            Entwurf gelöscht und der originale Entwurf wiederhergestellt. Sie
            können Ihren Entwurf herunterladen, falls Sie ihn lieber speichern
            wollen und ihn später wieder hochladen.
          </p>
          <p><strong>Wollen Sie mit dem Zurücksetzen fortfahren?</strong></p>
        </div>
        <div class="modal-footer">
          <button id="cancelReset" class="btn">Abbrechen</button>
          <button id="confirmReset" class="btn primary">
            Entwurf zurücksetzen
          </button>
        </div>
      </div>
    </div>

    <!-- Rendering-Modal -->
    <div id="renderingModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>PDF-Rendering konfigurieren</h2>
          <div class="header-controls">
            <button id="toggleAllColors" class="btn toggle-btn" data-state="on">
              <span class="toggle-text">Originale Farben</span>
              <span class="toggle-status green">An</span>
            </button>
            <button
              id="toggleAllTagsHidden"
              class="btn toggle-btn"
              data-state="off"
            >
              <span class="toggle-text">Alle Tags verstecken</span>
              <span class="toggle-status red">Aus</span>
            </button>
          </div>
          <button id="closeModal" class="btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="config-section">
            <h3>Tag-Konfiguration</h3>
            <div class="tag-table-container">
              <table id="tag-config-table">
                <thead>
                  <tr>
                    <th>Modifikation</th>
                    <th>hochgestellt</th>
                    <th>tiefgestellt</th>
                    <th>rot</th>
                    <th>orange</th>
                    <th>blau</th>
                    <th>grün</th>
                    <th>magenta</th>
                    <th>Tag nicht<br />zeigen</th>
                  </tr>
                </thead>
                <!-- TBODYs werden dynamisch per JavaScript eingefügt -->
              </table>
            </div>
            <p class="config-hint">
              Hinweis: Originale Tag-Konfiguration ist voreingestellt. Innerhalb
              einer Gruppe (z.B. Verben) überschreiben die weiter unten
              liegenden Farbeinstellungen die darüberliegenden. Beispiel: Tempus
              in der Gruppe Verben wird grün eingestellt, Aktiv in der Gruppe
              Verben aber rot. Dann erscheinen Verben in allen Tempora mit
              Passiv-, Medium- und Medium/Passiv-Tags grün, Verben mit Tag Aktiv
              aber rot. Wenn “Tag nicht zeigen” gewählt wird, werden die Worte
              selbst trotzdem die von Ihnen ausgewählte Farbe erhalten. Es wird
              zusätzlich zu dem von Ihnen konfigurierten PDF immer auch
              zusätzlich die _BlackWhite, _NoTags, _Tags, _Colour, _GR-Fett,
              _DE-Fett und _Normal Version erzeugt. Das Rendern der PDFs kann
              bis zu 2 Minuten dauern.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancelRendering" class="btn">Abbrechen</button>
          <button id="confirmRendering" class="btn primary">
            PDFs rendern
          </button>
        </div>
      </div>
    </div>

    <!-- Globale Utils -->
    <script src="utils.js"></script>
    <!-- Worker-Basis für Draft-Render -->
    <script>
      window.WORKER_BASE =
        "https://birkenbihl-draft-01.klemp-tobias.workers.dev";
    </script>
    <!-- Hauptlogik (deine vorhandene Datei) -->
    <script src="work.js"></script>

    <!-- Kleines Patch-Skript: Titel säubern, PDF-Links & Zoom -->
    <script>
      (function () {
        function cleanTitle() {
          const h = document.getElementById("pageTitle");
          if (!h) return;
          h.textContent = h.textContent.replace(/_/g, " ");
        }

        // PDF-Links aktualisieren, wenn sich die Iframe-Quelle ändert
        function hookPdfLinks() {
          const iframe = document.getElementById("pdfFrame");
          const dl = document.getElementById("btnPdfDownload");
          const open = document.getElementById("btnPdfOpenTab");
          if (!iframe || !dl || !open) return;

          const update = () => {
            const src = iframe.getAttribute("src") || "#";
            dl.href = src;
            // Dateiname aus dem Pfad ziehen
            try {
              const nm = src.split("/").pop() || "auswahl.pdf";
              dl.setAttribute("download", nm);
            } catch {}
            open.onclick = (e) => {
              e.preventDefault();
              if (src && src !== "#") window.open(src, "_blank");
            };
          };

          // sofort & bei Änderungen aktualisieren
          update();
          const mo = new MutationObserver(update);
          mo.observe(iframe, { attributes: true, attributeFilter: ["src"] });

          // Auch bei Klicks auf die Optionen absichern
          document.addEventListener("click", (ev) => {
            const t = ev.target;
            if (t && t.classList && t.classList.contains("seg-btn")) {
              setTimeout(update, 0);
            }
          });
        }

        // Einfache PDF-"Zooms" über CSS-Scale
        function setupPdfZoom() {
          function makeZoom(paneId, plusBtnId, minusBtnId) {
            const pane = document.getElementById(paneId);
            const plus = document.getElementById(plusBtnId);
            const minus = document.getElementById(minusBtnId);
            if (!pane || !plus || !minus) return;
            let scale = 1;
            const apply = () =>
              pane.style.setProperty("--pdfScale", String(scale));
            plus.addEventListener("click", () => {
              scale = Math.min(2.5, +(scale + 0.1).toFixed(2));
              apply();
            });
            minus.addEventListener("click", () => {
              scale = Math.max(0.6, +(scale - 0.1).toFixed(2));
              apply();
            });
            apply();
          }
          makeZoom("draftPdfPane", "btnDraftPdfZoomIn", "btnDraftPdfZoomOut");
        }

        // Text-Zoom-Funktionalität
        function setupTextZoom() {
          function makeTextZoom(textId, plusBtnId, minusBtnId) {
            const textElement = document.getElementById(textId);
            const plus = document.getElementById(plusBtnId);
            const minus = document.getElementById(minusBtnId);
            if (!textElement || !plus || !minus) return;

            let fontSize = 14; // Standard-Schriftgröße
            const apply = () => (textElement.style.fontSize = fontSize + "px");

            plus.addEventListener("click", () => {
              fontSize = Math.min(24, fontSize + 2);
              apply();
            });

            minus.addEventListener("click", () => {
              fontSize = Math.max(10, fontSize - 2);
              apply();
            });

            apply(); // Initial anwenden
          }

          makeTextZoom("origText", "btnOrigPlus", "btnOrigMinus");
          makeTextZoom("birkenbihlText", "btnBirPlus", "btnBirMinus");
          makeTextZoom("draftText", "btnDraftTextPlus", "btnDraftTextMinus");
        }

        // Download-Button-Funktionalität wird in work.js gehandhabt
        function setupDownloadButtons() {
          // Die Download-Buttons werden in work.js initialisiert
          // Hier nur Platzhalter für zukünftige Erweiterungen
        }

        document.addEventListener("DOMContentLoaded", () => {
          cleanTitle();
          hookPdfLinks();
          setupPdfZoom();
          setupTextZoom();
          setupDownloadButtons();
        });
      })();
    </script>
  </body>
</html>
