name: Build Draft PDFs

on:
  workflow_dispatch:
    inputs:
      draft_file:
        description: "Pfad zur Draft-Datei"
        required: false
        type: string
      kind:
        description: "Art (prosa/poesie)"
        required: false
        type: string
      author:
        description: "Autor"
        required: false
        type: string
      work:
        description: "Werk"
        required: false
        type: string
  push:
    paths:
      - "texte_drafts/**/*_birkenbihl_DRAFT_*.txt"
      - "build_prosa_drafts_adapter.py"
      - "build_poesie_drafts_adapter.py"
      - "prosa_pdf.py"
      - "poesie_pdf.py"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install reportlab

      - name: Install DejaVu fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans.ttf shared/fonts/
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf shared/fonts/
          ls -l shared/fonts/DejaVuSans*.ttf

      - name: Build Draft PDFs
        run: |
          echo "Build Draft PDFs gestartet..."

          # Prüfe ob spezifische Datei über Parameter übergeben wurde
          if [ -n "${{ github.event.inputs.draft_file }}" ]; then
            echo "Verarbeite spezifische Draft-Datei: ${{ github.event.inputs.draft_file }}"
            
            # Bestimme ob es Prosa oder Poesie ist
            if [[ "${{ github.event.inputs.draft_file }}" == *"/prosa_drafts/"* ]]; then
              echo "Erstelle Prosa PDFs für: ${{ github.event.inputs.draft_file }}"
              python build_prosa_drafts_adapter.py "${{ github.event.inputs.draft_file }}"
            elif [[ "${{ github.event.inputs.draft_file }}" == *"/poesie_drafts/"* ]]; then
              echo "Erstelle Poesie PDFs für: ${{ github.event.inputs.draft_file }}"
              python build_poesie_drafts_adapter.py "${{ github.event.inputs.draft_file }}"
            else
              echo "Unbekannter Draft-Typ für: ${{ github.event.inputs.draft_file }}"
            fi
          else
            echo "Suche nach neuen Draft-Dateien..."
            
            # Finde alle Draft-Dateien die in diesem Commit hinzugefügt wurden
            DRAFT_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'texte_drafts/.*_birkenbihl_DRAFT_.*\.txt$' || true)
            
            if [ -z "$DRAFT_FILES" ]; then
              echo "Keine neuen Draft-Dateien gefunden"
              exit 0
            fi
            
            echo "Gefundene Draft-Dateien:"
            echo "$DRAFT_FILES"
            
            # Verarbeite jede Draft-Datei
            for file in $DRAFT_FILES; do
              echo "Verarbeite: $file"
              
              # Bestimme ob es Prosa oder Poesie ist
              if [[ "$file" == *"/prosa_drafts/"* ]]; then
                echo "Erstelle Prosa PDFs für: $file"
                python build_prosa_drafts_adapter.py "$file"
              elif [[ "$file" == *"/poesie_drafts/"* ]]; then
                echo "Erstelle Poesie PDFs für: $file"
                python build_poesie_drafts_adapter.py "$file"
              else
                echo "Unbekannter Draft-Typ für: $file"
              fi
            done
          fi

      - name: Commit Draft PDFs
        uses: EndBug/add-and-commit@v9
        with:
          add: "pdf_drafts/**/*.pdf"
          message: "CI: Draft PDFs neu gebaut"
