name: Build Draft PDFs

on:
  workflow_dispatch:
    inputs:
      draft_file:
        description: "Pfad zur Draft-Datei"
        required: false
        type: string
      kind:
        description: "Art (prosa/poesie)"
        required: false
        type: string
      author:
        description: "Autor"
        required: false
        type: string
      work:
        description: "Werk"
        required: false
        type: string
  push:
    paths:
      - "texte_drafts/**/*_birkenbihl_DRAFT_*.txt"
      - "texte_drafts/**/*_DRAFT_*.txt"
      - "build_prosa_drafts_adapter.py"
      - "build_poesie_drafts_adapter.py"
      - "prosa_pdf.py"
      - "poesie_pdf.py"

concurrency:
  group: draft-pdf-build
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install reportlab

      - name: Install DejaVu fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans.ttf shared/fonts/
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf shared/fonts/
          ls -l shared/fonts/DejaVuSans*.ttf

      - name: Build Draft PDFs
        env:
          PYTHONUNBUFFERED: '1'
        run: |
          # ensure Python prints unbuffered so CI logs appear immediately
          export PYTHONUNBUFFERED=1
          set -x
          
          echo "Build Draft PDFs gestartet..."

          # Finde alle Draft-Dateien die in diesem Commit geändert wurden
          echo "Suche nach geänderten Draft-Dateien..."

          # Prüfe ob es vorherige Commits gibt
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            # Vergleiche mit vorherigem Commit
            DRAFT_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'texte_drafts/.*_DRAFT_.*\.txt$' || true)
          else
            # Erster Commit - suche alle Draft-Dateien
            echo "Erster Commit erkannt, suche alle Draft-Dateien..."
            DRAFT_FILES=$(find texte_drafts -name "*_DRAFT_*.txt" 2>/dev/null || true)
          fi

          if [ -z "$DRAFT_FILES" ]; then
            echo "Keine neuen Draft-Dateien gefunden"
            exit 0
          fi

          echo "Gefundene Draft-Dateien:"
          echo "$DRAFT_FILES"

          # Gruppiere Draft-Dateien nach Autor/Werk und sortiere nach Zeitstempel
          echo "Gruppiere und sortiere Draft-Dateien..."

          # Erstelle temporäre Datei für Gruppierung
          TEMP_GROUP_FILE=$(mktemp)

          for file in $DRAFT_FILES; do
            REL_PATH="${file#texte_drafts/}"
            DIR_PATH=$(dirname "$REL_PATH")
            FILENAME=$(basename "$REL_PATH")
            TIMESTAMP=$(echo "$FILENAME" | grep -o '[0-9]\{8\}_[0-9]\{6\}' || echo "00000000_000000")
            echo "${DIR_PATH}|${TIMESTAMP}|${file}" >> "$TEMP_GROUP_FILE"
          done

          # Sortiere nach Werkpfad und Zeitstempel (neueste zuerst)
          sort -t'|' -k1,1 -k2,2r "$TEMP_GROUP_FILE" > "${TEMP_GROUP_FILE}.sorted"

          # Verarbeite nur den neuesten Draft pro Werk
          CURRENT_GROUP=""
          while IFS='|' read -r DIR_PATH TIMESTAMP FILE; do
            GROUP_KEY="${DIR_PATH}"
            
            if [ "$GROUP_KEY" != "$CURRENT_GROUP" ]; then
              CURRENT_GROUP="$GROUP_KEY"
              echo "Verarbeite neuesten Draft: $FILE (Zeitstempel: $TIMESTAMP)"
              
              # Lösche alte PDFs für dieses Werk
              PDF_DIR="pdf_drafts/${DIR_PATH}"
              if [ -d "$PDF_DIR" ]; then
                echo "Lösche alte PDFs in: $PDF_DIR"
                find "$PDF_DIR" -name "*.pdf" -delete
              fi
              
              KIND=$(echo "$DIR_PATH" | cut -d'/' -f2)
              
              # Bestimme ob es Prosa oder Poesie ist und erstelle neue PDFs
              if [[ "$KIND" == "prosa" ]]; then
                echo "Erstelle Prosa PDFs für: $FILE"
                echo "LAUNCHING PYTHON: python build_prosa_drafts_adapter.py \"$(pwd)/$FILE\""
                python build_prosa_drafts_adapter.py "$(pwd)/$FILE"
              elif [[ "$KIND" == "poesie" ]]; then
                echo "Erstelle Poesie PDFs für: $FILE"
                echo "LAUNCHING PYTHON: python build_poesie_drafts_adapter.py \"$(pwd)/$FILE\""
                python build_poesie_drafts_adapter.py "$(pwd)/$FILE"
              else
                echo "Unbekannter Draft-Typ ($KIND) für: $FILE"
              fi
            else
              echo "Überspringe älteren Draft: $FILE (Zeitstempel: $TIMESTAMP)"
            fi
          done < "${TEMP_GROUP_FILE}.sorted"

          # Aufräumen
          rm -f "$TEMP_GROUP_FILE" "${TEMP_GROUP_FILE}.sorted"

      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Commit Draft PDFs
        run: |
          echo "Comitte PDF-Änderungen..."

          # Füge alle PDF-Änderungen hinzu (neue und gelöschte)
          git add pdf_drafts/
          
          # Füge auch alle anderen Änderungen hinzu (z.B. .gitkeep, temp-Dateien)
          git add -A

          # Prüfe ob es Änderungen gibt
          if git diff --cached --quiet; then
            echo "Keine PDF-Änderungen zu committen"
          else
            git commit -m "CI: Draft PDFs neu gebaut - $(date '+%Y-%m-%d %H:%M:%S')"
            echo "PDFs erfolgreich committed"
            
            # Push mit Retry-Logik (bis zu 5 Versuche)
            MAX_RETRIES=5
            RETRY_COUNT=0
            PUSH_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Push-Versuch $((RETRY_COUNT + 1)) von $MAX_RETRIES..."
              
              # Stelle sicher, dass keine unstaged changes vorhanden sind
              if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "→ Unstaged changes gefunden, füge sie hinzu..."
                git add -A
                if ! git diff --cached --quiet; then
                  git commit --amend --no-edit
                  echo "→ Änderungen zum vorherigen Commit hinzugefügt"
                fi
              fi
              
              # Hole neueste Änderungen mit Merge-Strategie "ours" für Binärdateien
              git fetch origin main
              
              # Versuche zu pushen
              if git push origin main; then
                echo "✓ PDFs erfolgreich gepusht"
                PUSH_SUCCESS=true
                # Warte 5 Sekunden, damit GitHub Pages Zeit hat, den Build zu starten
                echo "⏳ Warte 5 Sekunden für GitHub Pages..."
                sleep 5
                break
              else
                echo "⚠ Push fehlgeschlagen (nicht fast-forward), merge mit 'ours' Strategie..."
                
                # Merge mit "ours" Strategie für PDF-Konflikte
                if git merge origin/main -X ours --no-edit; then
                  echo "→ Merge erfolgreich mit 'ours' Strategie"
                  # Versuche erneut zu pushen
                  if git push origin main; then
                    echo "✓ PDFs erfolgreich gepusht nach Merge"
                    PUSH_SUCCESS=true
                    # Warte 5 Sekunden, damit GitHub Pages Zeit hat, den Build zu starten
                    echo "⏳ Warte 5 Sekunden für GitHub Pages..."
                    sleep 5
                    break
                  fi
                else
                  echo "⚠ Merge fehlgeschlagen, versuche erneut..."
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 3
              fi
            done
            
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "✗ Push nach $MAX_RETRIES Versuchen fehlgeschlagen"
              exit 1
            fi
          fi
