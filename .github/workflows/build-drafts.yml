name: Build Draft PDFs

on:
  workflow_dispatch:
    inputs:
      draft_file:
        description: "Pfad zur Draft-Datei"
        required: false
        type: string
      kind:
        description: "Art (prosa/poesie)"
        required: false
        type: string
      author:
        description: "Autor"
        required: false
        type: string
      work:
        description: "Werk"
        required: false
        type: string
  push:
    paths:
      - "texte_drafts/**/*_birkenbihl_DRAFT_*.txt"
      - "texte_drafts/**/*_DRAFT_*.txt"
      - "build_prosa_drafts_adapter.py"
      - "build_poesie_drafts_adapter.py"
      - "prosa_pdf.py"
      - "poesie_pdf.py"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install reportlab

      - name: Install DejaVu fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans.ttf shared/fonts/
          ln -sf /usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf shared/fonts/
          ls -l shared/fonts/DejaVuSans*.ttf

      - name: Build Draft PDFs
        run: |
          echo "Build Draft PDFs gestartet..."

          # Finde alle Draft-Dateien die in diesem Commit geändert wurden
          echo "Suche nach geänderten Draft-Dateien..."

          # Prüfe ob es vorherige Commits gibt
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            # Vergleiche mit vorherigem Commit
            DRAFT_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'texte_drafts/.*_DRAFT_.*\.txt$' || true)
          else
            # Erster Commit - suche alle Draft-Dateien
            echo "Erster Commit erkannt, suche alle Draft-Dateien..."
            DRAFT_FILES=$(find texte_drafts -name "*_DRAFT_*.txt" 2>/dev/null || true)
          fi

          if [ -z "$DRAFT_FILES" ]; then
            echo "Keine neuen Draft-Dateien gefunden"
            exit 0
          fi

          echo "Gefundene Draft-Dateien:"
          echo "$DRAFT_FILES"

          # Verarbeite jede Draft-Datei
          for file in $DRAFT_FILES; do
            echo "Verarbeite: $file"
            
            # Extrahiere Autor und Werk aus dem Pfad
            # z.B. texte_drafts/prosa_drafts/Platon/Menon/datei.txt
            IFS='/' read -ra PATH_PARTS <<< "$file"
            if [ ${#PATH_PARTS[@]} -ge 4 ]; then
              KIND_TYPE="${PATH_PARTS[1]}"  # prosa_drafts oder poesie_drafts
              AUTHOR="${PATH_PARTS[2]}"     # Platon
              WORK="${PATH_PARTS[3]}"       # Menon
              
              echo "Gefunden: Art=$KIND_TYPE, Autor=$AUTHOR, Werk=$WORK"
              
              # Lösche alte PDFs für dieses Werk
              PDF_DIR="pdf_drafts/${KIND_TYPE}/${AUTHOR}/${WORK}"
              if [ -d "$PDF_DIR" ]; then
                echo "Lösche alte PDFs in: $PDF_DIR"
                find "$PDF_DIR" -name "*.pdf" -delete
              fi
              
              # Bestimme ob es Prosa oder Poesie ist und erstelle neue PDFs
              if [[ "$KIND_TYPE" == "prosa_drafts" ]]; then
                echo "Erstelle Prosa PDFs für: $file"
                python build_prosa_drafts_adapter.py "$file"
              elif [[ "$KIND_TYPE" == "poesie_drafts" ]]; then
                echo "Erstelle Poesie PDFs für: $file"
                python build_poesie_drafts_adapter.py "$file"
              else
                echo "Unbekannter Draft-Typ für: $file"
              fi
            else
              echo "Ungültiger Pfad für: $file"
            fi
          done

      - name: Commit Draft PDFs
        run: |
          echo "Comitte PDF-Änderungen..."

          # Füge alle PDF-Änderungen hinzu (neue und gelöschte)
          git add pdf_drafts/

          # Prüfe ob es Änderungen gibt
          if git diff --cached --quiet; then
            echo "Keine PDF-Änderungen zu committen"
          else
            git commit -m "CI: Draft PDFs neu gebaut - $(date '+%Y-%m-%d %H:%M:%S')"
            echo "PDFs erfolgreich committed"
          fi
