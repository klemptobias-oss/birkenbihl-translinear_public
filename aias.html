<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aias – Werkseite</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .pdf-frame { width: 100%; height: 78vh; border: 1px solid var(--edge); background: #fafafa; }
      .pdf-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
      .pdf-controls .muted { margin-left:auto; }
      .radio { display:inline-flex; align-items:center; gap:6px; }
      .src { white-space: pre; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 0.92rem; line-height: 1.35; }
      .small { font-size: 0.85em; color: var(--muted); }
      .ok { color: #2a7; }
      .warn { color: #c71; }
      .err { color: #c33; }
      .save-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; background:#aaa; vertical-align:middle; }
      .save-dot.ok { background:#2a7; }
      .save-dot.busy { background:#c71; }
      details.settings { margin-top:8px; }
      details.settings summary { cursor:pointer; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- Kopfzeile -->
      <div class="bar">
        <a class="btn" href="index.html">← Zurück zur Startseite</a>
        <div class="title">Aias <span class="muted">Werkseite</span></div>
      </div>

      <!-- Hinweis -->
      <div class="notice">
        Links: <b>texte/Aias.txt</b> · Unten: <b>texte/Aias_birkenbihl.txt</b> (Original) und <b>Entwurf</b> (deine Live-Version) ·
        Rechts: eingebettetes PDF (Quelle: <b>Original</b>/<b>Entwurf</b>, Darstellung: <b>Normal</b>/<b>Fett</b>)
      </div>

      <!-- Oben: Grid (links Original, rechts PDF-Viewer) -->
      <div class="grid">
        <!-- Original (links) -->
        <section class="card">
          <h2>Original – Rohtext</h2>
          <div class="pane-body">
            <div class="split">
              <a class="btn" href="texte/Aias.txt" download>Herunterladen</a>
            </div>
            <object data="texte/Aias.txt" type="text/plain">
              <pre class="src">Konnte texte/Aias.txt nicht laden. Liegt die Datei im Ordner texte/?</pre>
            </object>
          </div>
        </section>

        <!-- PDF-Viewer (rechts) -->
        <section class="card">
          <h2>PDF</h2>
          <div class="pane-body">
            <div class="pdf-controls">
              <!-- Quelle: Original vs. Entwurf -->
              <span class="radio">
                <input type="radio" name="pdfsrc" id="src-original" value="original" checked />
                <label for="src-original">Original</label>
              </span>
              <span class="radio">
                <input type="radio" name="pdfsrc" id="src-draft" value="draft" />
                <label for="src-draft">Entwurf</label>
              </span>

              <!-- Darstellung: Normal vs. Fett -->
              <span class="radio" style="margin-left:12px">
                <input type="radio" name="pdfkind" id="pdf-normal" value="Normal" checked />
                <label for="pdf-normal">Normal</label>
              </span>
              <span class="radio">
                <input type="radio" name="pdfkind" id="pdf-fett" value="Fett" />
                <label for="pdf-fett">Fett</label>
              </span>

              <button class="btn" id="pdf-refresh" title="PDF neu laden">PDF aktualisieren</button>
              <a class="btn" href="pdf/TragödieAias_Normal.pdf" id="pdf-download" download>Aktuelles PDF herunterladen</a>
              <a class="btn" href="pdf/TragödieAias_Normal.pdf" id="pdf-open" target="_blank">Im neuen Tab öffnen</a>

              <span class="muted">PDF wird aus der Birkenbihl-Datei durch den Build erzeugt.</span>
            </div>

            <object id="pdf-frame" class="pdf-frame" type="application/pdf"
              data="pdf/TragödieAias_Normal.pdf#view=FitH">
              <p>PDF kann nicht eingebettet werden.</p>
            </object>
          </div>
        </section>
      </div>

      <!-- Unten: Birkenbihl-TXT mit Toggle Original/Entwurf, Editor, Autosave, PDF-Generieren -->
      <section class="card" style="margin-top: 16px">
        <h2>Birkenbihl – Text</h2>
        <div class="pane-body">
          <!-- Anzeige-Umschalter -->
          <div class="pdf-controls" style="margin-bottom:6px">
            <span class="radio">
              <input type="radio" name="bbview" id="bbview-original" value="original" checked />
              <label for="bbview-original">Original ansehen</label>
            </span>
            <span class="radio">
              <input type="radio" name="bbview" id="bbview-draft" value="draft" />
              <label for="bbview-draft">Entwurf ansehen</label>
            </span>

            <span class="small" id="save-indicator" style="margin-left:auto">
              <span class="save-dot" id="save-dot"></span><span id="save-text">Bereit</span>
            </span>
          </div>

          <!-- Button-Leiste -->
          <div class="split">
            <a class="btn" href="texte/Aias_birkenbihl.txt" download>Herunterladen (Original)</a>

            <button class="btn" id="bb-edit">Bearbeiten</button>
            <button class="btn" id="bb-cancel" style="display:none">Abbrechen</button>
            <a class="btn" id="bb-save" style="display:none" download="Aias_birkenbihl_DRAFT.txt">Entwurf als TXT speichern</a>

            <button class="btn" id="bb-generate">PDF generieren (Entwurf)</button>
          </div>

          <!-- Original-Ansicht -->
          <object id="bb-view-original" data="texte/Aias_birkenbihl.txt" type="text/plain">
            <pre class="src">Konnte texte/Aias_birkenbihl.txt nicht laden. Liegt die Datei im Ordner texte/?</pre>
          </object>

          <!-- Entwurfs-Ansicht -->
          <pre id="bb-view-draft" class="src" style="display:none; background:#f8f8f8; border:1px solid var(--edge); padding:8px; height:40vh; overflow:auto;"></pre>

          <!-- Editor (unsichtbar bis „Bearbeiten“) -->
          <textarea id="bb-editor" class="src" style="display:none;width:100%;height:calc(70vh - 64px);border:1px solid var(--edge);background:#fff;"></textarea>

          <!-- Leitfaden/Automatik (optional) -->
          <details class="settings">
            <summary>Erweiterte Automatik (optional): GitHub-Token lokal hinterlegen, um <i>PDF generieren</i> ohne manuellen Upload auszuführen</summary>
            <div class="small" style="margin-top:6px">
              <p>Optional kannst du ein GitHub-Token (nur für dieses Repo) lokal im Browser speichern. Dann lädt „PDF generieren“ deinen Entwurf
              automatisch nach <code>texte_drafts/</code> hoch und stößt den Build an.</p>
              <label>GitHub Token:
                <input id="gh-token" type="password" style="width:340px" placeholder="ghp_… (nur Inhalte-Rechte für dieses Repo)" />
              </label>
              <button class="btn" id="tok-save">Token speichern</button>
              <button class="btn" id="tok-clear">Token löschen</button>
              <span id="tok-status" class="small"></span>
              <p class="warn">Sicherheit: Das Token wird nur in deinem Browser (localStorage) gehalten und bei Bedarf an die GitHub-API gesendet. Nicht auf fremden Geräten verwenden.</p>
            </div>
          </details>

          <div id="draft-status" class="small" style="margin-top:8px"></div>

          <div class="notice" style="margin-top:8px">
            Hinweis: Der Entwurfsweg lässt das Original in <code>texte/</code> unberührt. Für „offizielle“ PDFs (im Ordner <code>pdf/</code>)
            ersetzt du später die Originaldatei in <code>texte/</code> und lässt den Haupt-Workflow laufen.
          </div>
        </div>
      </section>

      <!-- Quellen -->
      <div class="notice" style="margin-top: 12px">
        Quelle Originaltexte: Perseus Digital Library · Eigene Aufbereitung: Birkenbihl/Translinear
      </div>
    </div>

    <!-- Skript: Toggle/Autosave/Generieren + optionaler Auto-Upload -->
    <script>
      (function () {
        // ====== Repo-Konfiguration (an dein Repo angepasst) ======
        const OWNER = "klemptobias-oss";
        const REPO  = "birkenbihl-translinear_public";
        const BRANCH = "main";
        const DRAFT_UPLOAD_URL = `https://github.com/${OWNER}/${REPO}/upload/${BRANCH}/texte_drafts`;
        const ACTIONS_URL = `https://github.com/${OWNER}/${REPO}/actions/workflows/tragoedie-build-drafts.yml`;
        const DRAFT_PDF_BASE = "pdf_drafts/Aias_DRAFT_LATEST_"; // Normal/Fett
        const OFFICIAL_PDF_BASE = "pdf/TragödieAias_"; // Normal/Fett
        const LOCAL_KEY = "draft_Aias_birkenbihl"; // localStorage Key für Entwurf
        const TOKEN_KEY = "gh_pat_for_" + OWNER + "_" + REPO;
        const WORKER_URL = "https://birkenbihl-draft-01.klemp-tobias.workers.dev"; // <— deine Worker-URL

        // ====== Elemente ======
        const bbViewOriginal = document.getElementById("bb-view-original");
        const bbViewDraft = document.getElementById("bb-view-draft");
        const editor = document.getElementById("bb-editor");
        const btnEdit = document.getElementById("bb-edit");
        const btnCancel = document.getElementById("bb-cancel");
        const btnSave = document.getElementById("bb-save");
        const bbViewOrigRadio = document.getElementById("bbview-original");
        const bbViewDraftRadio = document.getElementById("bbview-draft");
        const saveDot = document.getElementById("save-dot");
        const saveText = document.getElementById("save-text");
        const btnGenerate = document.getElementById("bb-generate");
        const draftStatus = document.getElementById("draft-status");

        const pdfFrame = document.getElementById("pdf-frame");
        const pdfNormal = document.getElementById("pdf-normal");
        const pdfFett = document.getElementById("pdf-fett");
        const srcOriginal = document.getElementById("src-original");
        const srcDraft = document.getElementById("src-draft");
        const btnRefresh = document.getElementById("pdf-refresh");
        const btnPdfDownload = document.getElementById("pdf-download");
        const btnPdfOpen = document.getElementById("pdf-open");

        // Token-UI
        const tokInput = document.getElementById("gh-token");
        const tokSave = document.getElementById("tok-save");
        const tokClear = document.getElementById("tok-clear");
        const tokStatus = document.getElementById("tok-status");

        // ====== Helpers ======
        function setSaveState(state, msg) {
          // state: "ready" | "busy" | "ok"
          saveDot.classList.remove("ok", "busy");
          if (state === "busy") saveDot.classList.add("busy");
          if (state === "ok") saveDot.classList.add("ok");
          saveText.textContent = msg || (state === "ok" ? "Gespeichert" : state === "busy" ? "Speichere…" : "Bereit");
        }

        function loadLocalDraft() {
          return localStorage.getItem(LOCAL_KEY) || "";
        }
        function saveLocalDraft(text) {
          localStorage.setItem(LOCAL_KEY, text || "");
        }

        // Unicode-sichere Base64
        function toBase64Unicode(str) {
          const bytes = new TextEncoder().encode(str || "");
          let bin = "";
          bytes.forEach(b => bin += String.fromCharCode(b));
          return btoa(bin);
        }

        function currentPdfPath() {
          const kind = pdfFett.checked ? "Fett" : "Normal";
          const useDraft = srcDraft.checked;
          return (useDraft ? DRAFT_PDF_BASE : OFFICIAL_PDF_BASE) + kind + ".pdf";
        }
        function updatePdfLinks(bust=false) {
          const url = currentPdfPath();
          const bustUrl = url + (bust ? ("?t=" + Date.now()) : "");
          pdfFrame.setAttribute("data", bustUrl + "#view=FitH");
          btnPdfDownload.setAttribute("href", url);
          btnPdfOpen.setAttribute("href", url);
        }

        async function fetchText(path) {
          const res = await fetch(path, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          return await res.text();
        }

        // ====== Editor / Ansicht ======
        // Vorhandenen Draft wiederherstellen
        (function restoreDraft() {
          const draft = loadLocalDraft();
          if (draft) {
            bbViewDraft.textContent = draft;
            draftStatus.innerHTML = '<span class="ok">Entwurf aus lokalem Speicher wiederhergestellt.</span>';
          }
        })();

        function showEditor(text) {
          editor.value = text;
          bbViewOriginal.style.display = "none";
          bbViewDraft.style.display = "none";
          editor.style.display = "";
          btnEdit.style.display = "none";
          btnCancel.style.display = "";
          btnSave.style.display = "";
          setSaveState("ready", "Im Editor");
        }
        function hideEditor() {
          editor.style.display = "none";
          (bbViewDraftRadio.checked ? bbViewDraft : bbViewOriginal).style.display = "";
          btnEdit.style.display = "";
          btnCancel.style.display = "none";
          btnSave.style.display = "none";
          setSaveState("ready", "Bereit");
        }

        btnEdit?.addEventListener("click", async () => {
          setSaveState("busy");
          try {
            // Bevorzugt aktuellen Entwurf öffnen, sonst Original laden
            const draft = loadLocalDraft();
            const text = draft || await fetchText("texte/Aias_birkenbihl.txt");
            showEditor(text);
            setSaveState("ready", draft ? "Entwurf bearbeiten" : "Original bearbeiten");
          } catch (e) {
            setSaveState("ready");
            alert("Konnte Text nicht laden.\nFehler: " + e.message);
          }
        });
        btnCancel?.addEventListener("click", hideEditor);

        // Autosave + Live-Entwurfsansicht
        let saveTimer = null;
        editor.addEventListener("input", () => {
          setSaveState("busy");
          const val = editor.value;
          bbViewDraft.textContent = val;
          if (saveTimer) clearTimeout(saveTimer);
          saveTimer = setTimeout(() => {
            saveLocalDraft(val);
            setSaveState("ok", "Gespeichert");
          }, 300);
        });

        // Umschalter Original/Entwurf ansehen
        function setBBView(which) {
          if (editor.style.display !== "none") return; // im Editor nicht umschalten
          if (which === "draft") {
            bbViewOriginal.style.display = "none";
            bbViewDraft.style.display = "";
          } else {
            bbViewDraft.style.display = "none";
            bbViewOriginal.style.display = "";
          }
        }
        bbViewOrigRadio.addEventListener("change", () => setBBView("original"));
        bbViewDraftRadio.addEventListener("change", () => setBBView("draft"));

        // Entwurf als TXT speichern
        btnSave?.addEventListener("click", () => {
          const text = editor.value ?? "";
          const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          btnSave.href = url;
          setTimeout(() => URL.revokeObjectURL(url), 30000);
        });

        // ====== PDF-Einbettung steuern ======
        [pdfNormal, pdfFett, srcOriginal, srcDraft].forEach(el => {
          el?.addEventListener("change", () => updatePdfLinks(true));
        });
        btnRefresh.addEventListener("click", () => updatePdfLinks(true));
        updatePdfLinks(false);

        // ====== Optional: Token-Automatik ======
        // Lade evtl. gespeichertes Token
        const savedTok = localStorage.getItem(TOKEN_KEY) || "";
        if (savedTok) { tokInput.value = "********"; tokStatus.textContent = "Token vorhanden (lokal)."; }
        tokSave?.addEventListener("click", () => {
          const v = tokInput.value.trim();
          if (!v || v === "********") { tokStatus.textContent = "Kein neues Token eingegeben."; return; }
          localStorage.setItem(TOKEN_KEY, v);
          tokInput.value = "********";
          tokStatus.innerHTML = '<span class="ok">Token gespeichert (nur lokal).</span>';
        });
        tokClear?.addEventListener("click", () => {
          localStorage.removeItem(TOKEN_KEY);
          tokInput.value = "";
          tokStatus.innerHTML = '<span class="ok">Token gelöscht.</span>';
        });

        // ====== PDF generieren (Entwurf) ======
        btnGenerate?.addEventListener("click", async () => {
          draftStatus.innerHTML = "";
          // Quelle Text: Editor (falls offen) sonst lokaler Entwurf
          const text = (editor.style.display !== "none") ? editor.value : loadLocalDraft();
          if (!text || !text.trim()) {
            alert("Kein Entwurfstext vorhanden. Bitte auf „Bearbeiten“ klicken, Text anpassen und speichern.");
            return;
          }

          const token = localStorage.getItem(TOKEN_KEY) || "";
          if (!token) {
            // Safe-Modus: Datei als Download + Upload-Seite öffnen
            const fname = `Aias_birkenbihl_DRAFT_${Date.now()}.txt`;
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            // temporärer Download-Link
            const a = document.createElement("a");
            a.href = url; a.download = fname; document.body.appendChild(a); a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
            draftStatus.innerHTML = `📄 Entwurfsdatei <code>${fname}</code> gespeichert. Bitte hier hochladen: <a href="${DRAFT_UPLOAD_URL}" target="_blank">texte_drafts/</a>. Danach oben rechts „Entwurf“ wählen und „PDF aktualisieren“.`;
            window.open(DRAFT_UPLOAD_URL, "_blank");
            return;
          }

          // Pro-Modus: Automatischer Upload in texte_drafts via GitHub API
          try {
            draftStatus.innerHTML = "⬆️ Lade Entwurf hoch…";
            const fname = `Aias_birkenbihl_DRAFT_${new Date().toISOString().replace(/[:\-T]/g,'').slice(0,15)}.txt`;
            const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/texte_drafts/${fname}`;
            const body = {
              message: `draft: Aias birkenbihl (${fname})`,
              content: toBase64Unicode(text),
              branch: BRANCH
            };
            const res = await fetch(apiUrl, {
              method: "PUT",
              headers: {
                "Authorization": "token " + token,
                "Accept": "application/vnd.github+json",
                "Content-Type": "application/json"
              },
              body: JSON.stringify(body)
            });
            if (!res.ok) {
              const t = await res.text();
              throw new Error(`Upload fehlgeschlagen (${res.status}): ${t}`);
            }
            draftStatus.innerHTML = `✅ Entwurf hochgeladen. <a href="${ACTIONS_URL}" target="_blank">Build wird gestartet…</a>`;

            // Einfaches Polling: warte bis LATEST-PDF erreichbar, dann neu laden
            const targetNormal = DRAFT_PDF_BASE + "Normal.pdf";
            const targetFett   = DRAFT_PDF_BASE + "Fett.pdf";
            const want = pdfFett.checked ? targetFett : targetNormal;

            const ok = await waitForPdf(want, 24, 5_000); // bis zu ~2 min
            if (ok) {
              // auf Entwurf umschalten & neu laden
              srcDraft.checked = true;
              srcOriginal.checked = false;
              updatePdfLinks(true);
              draftStatus.innerHTML = draftStatus.innerHTML + ' – <span class="ok">PDF aktualisiert.</span>';
            } else {
              draftStatus.innerHTML = draftStatus.innerHTML + ' – <span class="warn">PDF noch nicht bereit. Probiere „PDF aktualisieren“ in Kürze.</span>';
            }
          } catch (e) {
            draftStatus.innerHTML = `<span class="err">Fehler: ${e.message}</span>`;
          }
        });

        async function waitForPdf(url, attempts, delayMs) {
          for (let i=0; i<attempts; i++) {
            try {
              const res = await fetch(url + "?check=" + Date.now(), { method: "HEAD", cache: "no-store" });
              if (res.ok) return true;
            } catch {}
            await new Promise(r => setTimeout(r, delayMs));
          }
          return false;
        }
      })();
    </script>
  </body>
</html>

      })();
    </script>
  </body>
</html>
