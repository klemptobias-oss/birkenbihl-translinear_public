<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aias – Werkseite</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="style_aias.css" />
  </head>
  <body>
    <div class="wrap">
      <!-- Kopfzeile -->
      <div class="bar">
        <a class="btn" href="index.html">← Zurück zur Startseite</a>
        <div class="title">Aias <span class="muted">Werkseite</span></div>
      </div>

      <!-- Hinweis -->
      <div class="notice">
        Links: <b>texte/Aias.txt</b> · Unten (breit): <b>Original (links)</b> & <b>Entwurf (rechts)</b> ·
        Rechts oben: eingebettetes PDF (Quelle: <b>Original</b>/<b>Entwurf</b>, Darstellung: <b>Normal</b>/<b>Fett</b>)
      </div>

      <!-- Oben: Grid (links Original, rechts PDF-Viewer) -->
      <div class="grid">
        <!-- Original (links) -->
        <section class="card">
          <h2>Original – Rohtext</h2>
          <div class="pane-body">
            <div class="split">
              <a class="btn" href="texte/Aias.txt" download>Herunterladen (Original.txt)</a>
            </div>
            <object data="texte/Aias.txt" type="text/plain">
              <pre class="src">Konnte texte/Aias.txt nicht laden. Liegt die Datei im Ordner texte/?</pre>
            </object>
          </div>
        </section>

        <!-- PDF-Viewer (rechts) -->
        <section class="card">
          <h2>PDF</h2>
          <div class="pane-body">
            <div class="pdf-controls">
              <!-- Quelle: Original vs. Entwurf -->
              <span class="radio">
                <input type="radio" name="pdfsrc" id="src-original" value="original" checked />
                <label for="src-original">Original</label>
              </span>
              <span class="radio">
                <input type="radio" name="pdfsrc" id="src-draft" value="draft" />
                <label for="src-draft">Entwurf</label>
              </span>

              <!-- Darstellung: Normal vs. Fett -->
              <span class="radio" style="margin-left:12px">
                <input type="radio" name="pdfkind" id="pdf-normal" value="Normal" checked />
                <label for="pdf-normal">Normal</label>
              </span>
              <span class="radio">
                <input type="radio" name="pdfkind" id="pdf-fett" value="Fett" />
                <label for="pdf-fett">Fett</label>
              </span>

              <button class="btn" id="pdf-refresh" title="PDF neu laden">PDF aktualisieren</button>
              <a class="btn" href="pdf/TragödieAias_Normal.pdf" id="pdf-download" download>Aktuelles PDF herunterladen</a>
              <a class="btn" href="pdf/TragödieAias_Normal.pdf" id="pdf-open" target="_blank">Im neuen Tab öffnen</a>

              <span class="muted">PDF wird aus der Birkenbihl-Datei durch den Build erzeugt.</span>
            </div>

            <object id="pdf-frame" class="pdf-frame" type="application/pdf"
              data="pdf/TragödieAias_Normal.pdf#view=FitH">
              <p>PDF kann nicht eingebettet werden.</p>
            </object>
          </div>
        </section>
      </div>

      <!-- Unten: Birkenbihl-TXT ZWEISPALTIG (breit, nur höher) -->
      <section class="card card-wide" style="margin-top:16px">
        <h2>Birkenbihl – Text</h2>
        <div class="small" style="display:flex; align-items:center; gap:10px; margin:6px 0 10px;">
          <span class="save-dot" id="save-dot"></span><span id="save-text" class="small">Bereit</span>
          <span id="draft-status" class="small" style="margin-left:auto"></span>
        </div>

        <div class="bb-grid">
          <!-- LINKE PANE: ORIGINAL (nur lesen) -->
          <div class="pane">
            <h3>Original</h3>
            <div class="pane-body">
              <div class="split">
                <a class="btn" href="texte/Aias_birkenbihl.txt" download>Herunterladen (Original.txt)</a>
                <button class="btn" id="bb-generate-original" title="PDF-Quelle oben auf Original stellen und neu laden">PDF generieren</button>
              </div>

              <!-- Anzeige-Schalter (nur für Darstellungsansicht) -->
              <div class="toggle-row">
                <label class="toggle" id="orig-toggle-tags">
                  <input type="checkbox" />
                  <span>Grammatikkürzel in Übersicht:</span>
                  <span class="state on" data-on="An" data-off="Aus">An</span>
                </label>
                <label class="toggle" id="orig-toggle-colors">
                  <input type="checkbox" />
                  <span>Farbkürzel in Übersicht:</span>
                  <span class="state on" data-on="An" data-off="Aus">An</span>
                </label>
              </div>

              <pre id="bb-original-pre" class="src srcbox">Lade Original…</pre>
            </div>
          </div>

          <!-- RECHTE PANE: ENTWURF (lesen/bearbeiten) -->
          <div class="pane">
            <h3>Entwurf</h3>
            <div class="pane-body">
              <div class="split">
                <button class="btn" id="bb-edit">Bearbeiten</button>
                <button class="btn" id="bb-cancel" style="display:none">Abbrechen</button>
                <button class="btn" id="bb-download-draft" title="Aktuellen Entwurf herunterladen (mit eindeutigem Code)">Herunterladen (Entwurf.txt)</button>
                <button class="btn" id="bb-reset" title="Nur den lokalen Entwurf löschen">Entwurf zurücksetzen</button>
                <button class="btn" id="bb-generate-draft" title="Entwurf als PDF bauen (Cloud-Worker)">PDF generieren</button>
              </div>

              <!-- Anzeige-Schalter (nur für Darstellungsansicht) -->
              <div class="toggle-row">
                <label class="toggle" id="draft-toggle-tags">
                  <input type="checkbox" />
                  <span>Grammatikkürzel in Übersicht:</span>
                  <span class="state on" data-on="An" data-off="Aus">An</span>
                </label>
                <label class="toggle" id="draft-toggle-colors">
                  <input type="checkbox" />
                  <span>Farbkürzel in Übersicht:</span>
                  <span class="state on" data-on="An" data-off="Aus">An</span>
                </label>
              </div>

              <!-- Anzeige-Ansicht -->
              <pre id="bb-view-draft" class="src srcbox" style="display:block;"></pre>

              <!-- Editor-Ansicht -->
              <textarea id="bb-editor" class="editor" style="display:none;"></textarea>
            </div>
          </div>
        </div>

        <div class="notice" style="margin-top:10px">
          Der Entwurfsweg lässt das Original in <code>texte/</code> unberührt. Für „offizielle“ PDFs ersetzt du später
          die Originaldatei in <code>texte/</code> und lässt den Haupt-Workflow laufen.
        </div>
      </section>

      <!-- Quellen -->
      <div class="notice" style="margin-top:12px">
        Quelle Originaltexte: Perseus Digital Library · Eigene Aufbereitung: Birkenbihl/Translinear
      </div>
    </div>

    <!-- Bestätigungs-Modal: Entwurf zurücksetzen -->
    <div id="confirm-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-hidden="true">
      <div class="modal" role="document">
        <div class="modal-header">
          <div id="confirm-title" class="modal-title">Entwurf zurücksetzen?</div>
          <button class="modal-close" id="confirm-close" aria-label="Schließen">×</button>
        </div>
        <div class="modal-body">
          <p>Dieser Schritt wird Ihren Entwurf <b>unwiderruflich löschen</b> und ihn auf den <b>Originalzustand</b> zurücksetzen.</p>
          <p>Falls Sie Ihren Entwurf speichern möchten, klicken Sie auf <b>„Herunterladen (Entwurf.txt)“</b>. Sie können ihn dann auch offline bearbeiten und später neu hochladen.</p>
          <p><b>Wollen Sie mit der Löschung Ihres Entwurfs fortfahren?</b></p>
        </div>
        <div class="modal-actions">
          <button class="btn secondary" id="confirm-cancel">Abbrechen</button>
          <button class="btn danger" id="confirm-ok">Entwurf zurücksetzen</button>
        </div>
      </div>
    </div>

    <!-- Modal: PDF-Optionen -->
    <div id="opt-backdrop" class="opt-backdrop" role="dialog" aria-modal="true" aria-labelledby="opt-title" aria-hidden="true">
      <div class="opt-modal" role="document">
        <div class="opt-header">
          <div id="opt-title" class="opt-title">PDF-Optionen</div>
          <button class="modal-close" id="opt-close" aria-label="Schließen">×</button>
        </div>
        <div class="opt-body">
          <!-- Basisoptionen -->
          <div class="opt-section">
            <div class="opt-row">
              <label class="opt-check">
                <input type="checkbox" id="opt-colors" checked />
                <span>Farben zeigen</span>
              </label>
              <label class="opt-check">
                <input type="checkbox" id="opt-tags" checked />
                <span>Grammatikürzel zeigen</span>
              </label>
              <div class="muted-note">Tipp: Für Schwarz-Weiß die Farben abwählen; für „reine Birkenbihl“ die Grammatikürzel abwählen.</div>
            </div>
          </div>

          <!-- Benutzerdefiniert (aufklappbar) -->
          <details class="opt-adv" id="opt-adv">
            <summary>Benutzerdefiniert</summary>
            <div class="opt-section" style="margin-top:10px">
              <div class="opt-row">
                <div><b>Farbregeln (Beispiel, PoS-basiert)</b></div>
                <label class="opt-check">
                  <input type="checkbox" id="opt-color-n" checked />
                  <span><span class="opt-color-chip chip-red">Substantive (N)</span> rot</span>
                </label>
                <label class="opt-check">
                  <input type="checkbox" id="opt-color-v" checked />
                  <span><span class="opt-color-chip chip-green">Verben (V)</span> grün</span>
                </label>
                <label class="opt-check">
                  <input type="checkbox" id="opt-color-aj" checked />
                  <span><span class="opt-color-chip chip-blue">Adjektive/Partizipien (Aj)</span> blau</span>
                </label>
              </div>
            </div>

            <div class="opt-section">
              <div class="opt-row">
                <div><b>Ein-/Ausblenden von Kürzeln</b></div>
                <label class="opt-check"><input type="checkbox" id="tag-Av" checked /> <span>(Av) Adverb</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-Pt" checked /> <span>(Pt) Partikel</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-Ko" checked /> <span>(Ko) Konjunktion</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-Art" checked /> <span>(Art) Artikel</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-Aj" checked /> <span>(Aj) Adjektiv/Partizip</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-V"  checked /> <span>(V) Verb</span></label>
                <label class="opt-check"><input type="checkbox" id="tag-N"  checked /> <span>(N) Nomen/Substantiv</span></label>
                <div class="muted-note">Diese Liste ist ein Auszug. (Vollständige Steuerung folgt im Backend.)</div>
              </div>
            </div>
          </details>
        </div>
        <div class="opt-actions">
          <span class="muted-note" id="opt-context-note"></span>
          <button class="btn secondary" id="opt-cancel">Abbrechen</button>
          <button class="btn" id="opt-generate">PDF generieren</button>
        </div>
      </div>
    </div>

    <!-- Skript -->
    <script>
      (function () {
        // ====== Konfiguration ======
        const DRAFT_PDF_BASE   = "pdf_drafts/Aias_DRAFT_LATEST_"; // Normal/Fett + evtl. Suffix
        const OFFICIAL_PDF_BASE= "pdf/TragödieAias_";             // Normal/Fett
        const LOCAL_KEY        = "draft_Aias_birkenbihl";         // localStorage Key für Entwurf
        const WORKER_URL       = "https://birkenbihl-draft-01.klemp-tobias.workers.dev"; // ggf. anpassen

        // ====== Elemente oben (PDF) ======
        const pdfFrame = document.getElementById("pdf-frame");
        const pdfNormal = document.getElementById("pdf-normal");
        const pdfFett = document.getElementById("pdf-fett");
        const srcOriginal = document.getElementById("src-original");
        const srcDraft = document.getElementById("src-draft");
        const btnRefresh = document.getElementById("pdf-refresh");
        const btnPdfDownload = document.getElementById("pdf-download");
        const btnPdfOpen = document.getElementById("pdf-open");

        // ====== Elemente unten (Birkenbihl) ======
        const origPre = document.getElementById("bb-original-pre");
        const draftPre = document.getElementById("bb-view-draft");
        const editor = document.getElementById("bb-editor");
        const btnEdit = document.getElementById("bb-edit");
        const btnCancel = document.getElementById("bb-cancel");
        const btnDownloadDraft = document.getElementById("bb-download-draft");
        const btnGenerateOrig = document.getElementById("bb-generate-original");
        const btnGenerateDraft = document.getElementById("bb-generate-draft");
        const btnReset = document.getElementById("bb-reset");

        // Anzeige-Schalter (Original)
        const origToggleTags = document.getElementById("orig-toggle-tags");
        const origToggleColors = document.getElementById("orig-toggle-colors");
        // Anzeige-Schalter (Entwurf)
        const draftToggleTags = document.getElementById("draft-toggle-tags");
        const draftToggleColors = document.getElementById("draft-toggle-colors");

        // Modal: Zurücksetzen
        const modalBackdrop = document.getElementById("confirm-backdrop");
        const modalClose = document.getElementById("confirm-close");
        const modalCancel = document.getElementById("confirm-cancel");
        const modalOk = document.getElementById("confirm-ok");

        // Modal: Optionen
        const optBackdrop = document.getElementById("opt-backdrop");
        const optClose = document.getElementById("opt-close");
        const optCancel = document.getElementById("opt-cancel");
        const optGenerate = document.getElementById("opt-generate");
        const optColors = document.getElementById("opt-colors");
        const optTags = document.getElementById("opt-tags");
        const optAdv = document.getElementById("opt-adv");
        const optColorN = document.getElementById("opt-color-n");
        const optColorV = document.getElementById("opt-color-v");
        const optColorAj= document.getElementById("opt-color-aj");
        const tagAv = document.getElementById("tag-Av");
        const tagPt = document.getElementById("tag-Pt");
        const tagKo = document.getElementById("tag-Ko");
        const tagArt= document.getElementById("tag-Art");
        const tagAj = document.getElementById("tag-Aj");
        const tagV  = document.getElementById("tag-V");
        const tagN  = document.getElementById("tag-N");
        const optContextNote = document.getElementById("opt-context-note");

        // Save-Indikator
        const saveDot = document.getElementById("save-dot");
        const saveText = document.getElementById("save-text");
        const draftStatus = document.getElementById("draft-status");

        // ====== Helpers ======
        function setSaveState(state, msg) {
          saveDot.classList.remove("ok","busy");
          if (state==="busy") saveDot.classList.add("busy");
          if (state==="ok")   saveDot.classList.add("ok");
          saveText.textContent = msg || (state==="ok"?"Gespeichert":state==="busy"?"Speichere…":"Bereit");
        }
        function loadLocalDraft(){ return localStorage.getItem(LOCAL_KEY) || ""; }
        function saveLocalDraft(t){ localStorage.setItem(LOCAL_KEY, t||""); }

        async function fetchText(path) {
          const r = await fetch(path, { cache:"no-store" });
          if (!r.ok) throw new Error("HTTP "+r.status);
          return await r.text();
        }
        function currentPdfPath(suffix="") {
          const kind = pdfFett.checked ? "Fett" : "Normal";
          return (srcDraft.checked ? DRAFT_PDF_BASE : OFFICIAL_PDF_BASE) + kind + (suffix||"") + ".pdf";
        }
        function updatePdfLinks(bust=false, suffix=""){
          const url = currentPdfPath(suffix);
          const withBust = url + (bust ? ("?t="+Date.now()) : "");
          pdfFrame.setAttribute("data", withBust + "#view=FitH");
          btnPdfDownload.setAttribute("href", url);
          btnPdfOpen.setAttribute("href", url);
        }
        async function waitForPdf(url, attempts, delayMs){
          for (let i=0;i<attempts;i++){
            try { const r = await fetch(url + "?check="+Date.now(), { method:"HEAD", cache:"no-store" }); if (r.ok) return true; } catch {}
            await new Promise(r=>setTimeout(r, delayMs));
          }
          return false;
        }

        // Anzeige-Filter: nur für die Übersicht (pre), nicht für den Editor
        function stripGrammarTags(text){
          // Entfernt alle (...) Tags (sehr bewusst „großzügig“)
          return (text||"").replace(/\([^()\n]*\)/g, "");
        }
        function stripColorPrefixes(text){
          // Entfernt führende # + - pro Token
          return (text||"").split(/\n/).map(line=>{
            return line.split(/\s+/).map(tok=>{
              if (!tok) return tok;
              const first = tok.charAt(0);
              if (first === "#" || first === "+" || first === "-") return tok.slice(1);
              return tok;
            }).join(" ");
          }).join("\n");
        }
        function renderWithFilters(rawText, hideTags, hideColors){
          let out = rawText || "";
          if (hideTags)   out = stripGrammarTags(out);
          if (hideColors) out = stripColorPrefixes(out);
          return out;
        }

        // Toggle-Label farbig setzen
        function updateToggleLabel(toggleEl, isOn){
          const state = toggleEl.querySelector(".state");
          state.textContent = isOn ? (state.dataset.on||"An") : (state.dataset.off||"Aus");
          state.classList.toggle("on",  isOn);
          state.classList.toggle("off", !isOn);
        }

        // ====== Start: Original laden & lokalen Entwurf anzeigen ======
        let rawOriginal = "";
        let rawDraft = "";

        (async function initTexts(){
          try { rawOriginal = await fetchText("texte/Aias_birkenbihl.txt"); }
          catch(e){ rawOriginal = "Konnte texte/Aias_birkenbihl.txt nicht laden. Liegt die Datei im Ordner texte/?"; }
          // Default: beide Schalter „An“ (anzeigen), also keine Filter
          updateToggleLabel(origToggleTags, true);
          updateToggleLabel(origToggleColors, true);
          origPre.textContent = renderWithFilters(rawOriginal, false, false);

          rawDraft = loadLocalDraft() || "";
          updateToggleLabel(draftToggleTags, true);
          updateToggleLabel(draftToggleColors, true);
          draftPre.textContent = renderWithFilters(rawDraft, false, false);
        })();

        // ====== Anzeige-Schalter verknüpfen ======
        // Original
        origToggleTags.addEventListener("click", ()=>{
          const input = origToggleTags.querySelector("input");
          input.checked = !input.checked;
          const on = input.checked;
          updateToggleLabel(origToggleTags, on);
          const hideTags = !on;
          const hideColors = !(origToggleColors.querySelector("input").checked);
          origPre.textContent = renderWithFilters(rawOriginal, hideTags, hideColors);
        });
        origToggleColors.addEventListener("click", ()=>{
          const input = origToggleColors.querySelector("input");
          input.checked = !input.checked;
          const on = input.checked;
          updateToggleLabel(origToggleColors, on);
          const hideColors = !on;
          const hideTags = !(origToggleTags.querySelector("input").checked);
          origPre.textContent = renderWithFilters(rawOriginal, hideTags, hideColors);
        });

        // Entwurf
        draftToggleTags.addEventListener("click", ()=>{
          const input = draftToggleTags.querySelector("input");
          input.checked = !input.checked;
          const on = input.checked;
          updateToggleLabel(draftToggleTags, on);
          const hideTags = !on;
          const hideColors = !(draftToggleColors.querySelector("input").checked);
          draftPre.textContent = renderWithFilters(rawDraft, hideTags, hideColors);
        });
        draftToggleColors.addEventListener("click", ()=>{
          const input = draftToggleColors.querySelector("input");
          input.checked = !input.checked;
          const on = input.checked;
          updateToggleLabel(draftToggleColors, on);
          const hideColors = !on;
          const hideTags = !(draftToggleTags.querySelector("input").checked);
          draftPre.textContent = renderWithFilters(rawDraft, hideTags, hideColors);
        });

        // ====== Editor-Logik (rechts) ======
        function showEditor(text){
          editor.value = text;
          editor.style.display = "block";
          draftPre.style.display = "none";
          btnEdit.style.display = "inline-block"; // sichtbar lassen – auf Wunsch
          btnCancel.style.display = "inline-block";
          setSaveState("ready","Im Editor");
        }
        function hideEditor(){
          editor.style.display = "none";
          draftPre.style.display = "block";
          btnCancel.style.display = "none";
          setSaveState("ready","Bereit");
        }

        btnEdit.addEventListener("click", async ()=>{
          setSaveState("busy");
          try {
            const draft = loadLocalDraft();
            const text = draft || rawOriginal || await fetchText("texte/Aias_birkenbihl.txt");
            showEditor(text);
            setSaveState("ready", draft ? "Entwurf bearbeiten" : "Original bearbeiten");
          } catch(e){ setSaveState("ready"); alert("Konnte Text nicht laden: "+e.message); }
        });
        btnCancel.addEventListener("click", hideEditor);

        // Autosave + Live-Entwurfsanzeige (mit Filtern der Anzeige je nach Schalter)
        let saveTimer=null;
        editor.addEventListener("input", ()=>{
          setSaveState("busy");
          rawDraft = editor.value;
          const hideTags = !(draftToggleTags.querySelector("input").checked);
          const hideColors = !(draftToggleColors.querySelector("input").checked);
          draftPre.textContent = renderWithFilters(rawDraft, hideTags, hideColors);
          if (saveTimer) clearTimeout(saveTimer);
          saveTimer=setTimeout(()=>{ saveLocalDraft(rawDraft); setSaveState("ok","Gespeichert"); }, 300);
        });

        // ====== Herunterladen (Entwurf.txt) mit Kurzcode ======
        async function sha256Hex(str){
          const enc = new TextEncoder().encode(str);
          const buf = await crypto.subtle.digest("SHA-256", enc);
          const view = new Uint8Array(buf);
          return Array.from(view).map(b=>b.toString(16).padStart(2,"0")).join("");
        }
        async function diffCode(original, draft){
          const hex = await sha256Hex((original||"") + "|" + (draft||""));
          return hex.slice(0, 8);
        }
        btnDownloadDraft.addEventListener("click", async ()=>{
          const text = (editor.style.display!=="none") ? (editor.value||"") : (rawDraft||"");
          if (!text.trim()){
            alert("Kein Entwurf vorhanden. Bitte auf „Bearbeiten“ klicken, Text anpassen und speichern.");
            return;
          }
          try {
            const code = await diffCode(rawOriginal||"", text);
            const fname = `Aias_birkenbihl_ENTWURF_${code}.txt`;
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = fname;
            document.body.appendChild(a); a.click();
            setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
          } catch(e){ alert("Konnte Entwurf nicht herunterladen: " + e.message); }
        });

        // ====== PDF-Einbettung steuern (oben) ======
        function updatePdf(bust=false, suffix=""){
          const url = (function(){
            const kind = pdfFett.checked ? "Fett" : "Normal";
            const base = (srcDraft.checked ? DRAFT_PDF_BASE : OFFICIAL_PDF_BASE);
            return base + kind + (suffix||"") + ".pdf";
          })();
          const withBust = url + (bust ? ("?t="+Date.now()) : "");
          pdfFrame.setAttribute("data", withBust + "#view=FitH");
          btnPdfDownload.setAttribute("href", url);
          btnPdfOpen.setAttribute("href", url);
        }
        [pdfNormal,pdfFett,srcOriginal,srcDraft].forEach(el=>el.addEventListener("change", ()=>updatePdf(true)));
        btnRefresh.addEventListener("click", ()=>updatePdf(true));
        updatePdf(false);

        // ====== Zurücksetzen (mit Bestätigungs-Modal) ======
        function openConfirm(){ modalBackdrop.style.display = "flex"; modalBackdrop.setAttribute("aria-hidden","false"); }
        function closeConfirm(){ modalBackdrop.style.display = "none";  modalBackdrop.setAttribute("aria-hidden","true"); }
        btnReset.addEventListener("click", openConfirm);
        modalClose.addEventListener("click", closeConfirm);
        modalCancel.addEventListener("click", closeConfirm);
        modalBackdrop.addEventListener("click", (e)=>{ if (e.target === modalBackdrop) closeConfirm(); });
        document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && modalBackdrop.style.display === "flex") closeConfirm(); });

        modalOk.addEventListener("click", ()=>{
          localStorage.removeItem(LOCAL_KEY);
          rawDraft = "";
          draftPre.textContent = "";
          if (editor.style.display !== "none") editor.value = "";
          draftStatus.innerHTML = '<span class="ok">Lokaler Entwurf gelöscht.</span>';
          setSaveState("ready","Bereit");
          closeConfirm();
        });

        // ====== PDF-Optionen Modal ======
        let optContext = "draft"; // "draft" | "original"
        const optContextNote = document.getElementById("opt-context-note");
        function openOptModal(context){
          optContext = context;
          optContextNote.textContent = (context==="original")
            ? "Hinweis: Offizielle PDFs werden durch den Haupt-Workflow erzeugt. Dieser Dialog stellt oben die Anzeige auf „Original“."
            : "Der Entwurf wird mit diesen Optionen gebaut und oben angezeigt.";
          optBackdrop.style.display = "flex"; optBackdrop.setAttribute("aria-hidden","false");
        }
        function closeOptModal(){
          optBackdrop.style.display = "none";  optBackdrop.setAttribute("aria-hidden","true");
        }
        document.getElementById("opt-close").addEventListener("click", closeOptModal);
        document.getElementById("opt-cancel").addEventListener("click", closeOptModal);
        optBackdrop.addEventListener("click", (e)=>{ if (e.target === optBackdrop) closeOptModal(); });
        document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && optBackdrop.style.display === "flex") closeOptModal(); });

        // Buttons, die das Options-Modal öffnen
        btnGenerateOrig.addEventListener("click", ()=>openOptModal("original"));
        btnGenerateDraft.addEventListener("click", ()=>openOptModal("draft"));

        function suffixFromOptions() {
          let suffix = "";
          if (!document.getElementById("opt-colors").checked) suffix += "_BW";
          if (!document.getElementById("opt-tags").checked)   suffix += "_NoTags";
          if (document.getElementById("opt-adv").open)        suffix += "_Custom";
          return suffix;
        }
        function collectOptionsPayload() {
          return {
            colors:  !!document.getElementById("opt-colors").checked,
            showTags:!!document.getElementById("opt-tags").checked,
            custom: document.getElementById("opt-adv").open ? {
              colorByPOS: {
                N:  !!document.getElementById("opt-color-n").checked,
                V:  !!document.getElementById("opt-color-v").checked,
                Aj: !!document.getElementById("opt-color-aj").checked
              },
              visibleTags: {
                Av: !!document.getElementById("tag-Av").checked,
                Pt: !!document.getElementById("tag-Pt").checked,
                Ko: !!document.getElementById("tag-Ko").checked,
                Art:!!document.getElementById("tag-Art").checked,
                Aj: !!document.getElementById("tag-Aj").checked,
                V:  !!document.getElementById("tag-V").checked,
                N:  !!document.getElementById("tag-N").checked
              }
            } : null
          };
        }

        // Generieren (je nach Kontext)
        optGenerate.addEventListener("click", async ()=>{
          const suffix = suffixFromOptions();

          if (optContext === "original") {
            // UI-Only: oben auf Original umschalten & neu laden
            srcOriginal.checked = true; srcDraft.checked = false;
            updatePdf(true); // OFFICIAL hat keine Suffixe
            draftStatus.innerHTML = '<span class="small">Quelle auf <b>Original</b> umgestellt.</span>';
            closeOptModal();
            return;
          }

          // Entwurf: wirklicher Build
          const text = (editor.style.display!=="none") ? editor.value : (rawDraft||"");
          if (!text.trim()) { alert("Kein Entwurfstext vorhanden. Bitte auf „Bearbeiten“ klicken, Text anpassen und speichern."); return; }

          try {
            draftStatus.textContent = "⬆️ Entwurf wird an den Build-Dienst gesendet…";
            const opts = collectOptionsPayload();
            const res = await fetch(WORKER_URL + "/draft", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ work: "Aias", text, opts })
            });
            const j = await res.json().catch(()=> ({}));
            if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP "+res.status));

            draftStatus.textContent = "✅ Entwurf angenommen. Build startet…";
            // Umschalten auf Entwurf + PDF neu prüfen
            srcDraft.checked = true; srcOriginal.checked = false;

            const kind = pdfFett.checked ? "Fett" : "Normal";
            const target = `pdf_drafts/Aias_DRAFT_LATEST_${kind}${suffix}.pdf`;
            const ok = await waitForPdf(target, 24, 5000); // ~2 min
            updatePdf(true, suffix);
            if (ok) {
              draftStatus.innerHTML = '✅ Entwurfs-PDF aktualisiert.';
            } else {
              draftStatus.innerHTML = '⚠️ PDF noch nicht bereit. Bitte später „PDF aktualisieren“ klicken.';
            }
          } catch(e) {
            draftStatus.innerHTML = '<span class="err">Fehler: '+e.message+'</span>';
          } finally {
            closeOptModal();
          }
        });
      })();
    </script>
  </body>
</html>
