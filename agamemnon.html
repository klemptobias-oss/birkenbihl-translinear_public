<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Agamemnon – Werkseite</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- ######## START: Werkseite – Agamemnon ######## -->
    <div class="wrap">
      <!-- Kopfzeile -->
      <div class="bar">
        <a class="btn" href="index.html">← Zurück zur Startseite</a>
        <div class="title">Agamemnon <span class="muted">Werkseite</span></div>
      </div>

      <!-- Hinweis -->
      <div class="notice">
        Oben links: <b>texte/Agamemnon.txt</b> · Unten:
        <b>texte/Agamemnon_birkenbihl.txt</b><br />
        Beide Dateien gehören in den Ordner <code>texte/</code>.
      </div>

      <!-- Oben: Grid (links Original, rechts Platzhalter) -->
      <div class="grid">
        <!-- Original (links) -->
        <section class="card">
          <h2>Original – Rohtext</h2>
          <div class="pane-body">
            <div class="split">
              <a class="btn" href="texte/Agamemnon.txt" download
                >Herunterladen</a
              >
            </div>
            <object data="texte/Agamemnon.txt" type="text/plain">
              <pre class="src">
Konnte texte/Agamemnon.txt nicht laden. Liegt die Datei im Ordner texte/?</pre
              >
            </object>
          </div>
        </section>

        <!-- Platzhalter (rechts) -->
        <section class="card">
          <h2>PDF/Extras – Platzhalter</h2>
          <div class="pane-body">
            <p class="muted">
              Hier kommt später die PDF-Ansicht bzw. Werkzeuge (Suche,
              Vers-Sprünge, PDF-Generator usw.). Aktuell bewusst leer gelassen.
            </p>
          </div>
        </section>
      </div>

      <!-- Unten: Birkenbihl-TXT mit Bearbeiten-Modus -->
      <section class="card" style="margin-top: 16px">
        <h2>Birkenbihl – Text</h2>
        <div class="pane-body">
          <!-- ======= UPPER TRANSITION: Buttons-Erweiterung ======= -->
          <div class="split">
            <a class="btn" href="texte/Agamemnon_birkenbihl.txt" download
              >Herunterladen</a
            >
            <button class="btn" id="bb-edit">Bearbeiten</button>
            <button class="btn" id="bb-cancel" style="display: none">
              Abbrechen
            </button>
            <a
              class="btn"
              id="bb-save"
              style="display: none"
              download="Agamemnon_birkenbihl.txt"
              >Geänderte TXT herunterladen</a
            >
            <!-- NEU: PDF-Button -->
            <button class="btn" id="bb-pdf">PDF generieren</button>
          </div>
          <!-- ======= LOWER TRANSITION: Buttons-Erweiterung ======= -->

          <!-- Vorschau (Standard) -->
          <object
            id="bb-view"
            data="texte/Agamemnon_birkenbihl.txt"
            type="text/plain"
          >
            <pre class="src">
Konnte texte/Agamemnon_birkenbihl.txt nicht laden. Liegt die Datei im Ordner texte/?</pre
            >
          </object>

          <!-- Editor (versteckt bis „Bearbeiten“) -->
          <textarea
            id="bb-editor"
            class="src"
            style="
              display: none;
              width: 100%;
              height: calc(70vh - 64px);
              border: 1px solid var(--edge);
              background: #f7f7f7;
            "
          ></textarea>
        </div>
      </section>

      <!-- Quellen -->
      <div class="notice" style="margin-top: 12px">
        Quelle Originaltexte: Perseus Digital Library · Eigene Aufbereitung:
        Birkenbihl/Translinear
      </div>
    </div>
    <!-- ######## ENDE: Werkseite – Agamemnon ######## -->

    <!-- ######## START: Skript – Bearbeiten + PDF ######## -->
    <script>
      (function () {
        // Pfad zur Birkenbihl-TXT (werkspezifisch)
        const filePath = "texte/Agamemnon_birkenbihl.txt";

        const btnEdit = document.getElementById("bb-edit");
        const btnCancel = document.getElementById("bb-cancel");
        const btnSave = document.getElementById("bb-save");
        const btnPdf = document.getElementById("bb-pdf");
        const view = document.getElementById("bb-view");
        const editor = document.getElementById("bb-editor");

        async function loadText(path) {
          const res = await fetch(path, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          return await res.text();
        }

        function showEditor(text) {
          editor.value = text;
          view.style.display = "none";
          editor.style.display = "";
          btnEdit.style.display = "none";
          btnCancel.style.display = "";
          btnSave.style.display = "";
        }

        function showView() {
          editor.style.display = "none";
          view.style.display = "";
          btnEdit.style.display = "";
          btnCancel.style.display = "none";
          btnSave.style.display = "none";
        }

        btnEdit?.addEventListener("click", async () => {
          try {
            const txt = await loadText(filePath);
            showEditor(txt);
          } catch (e) {
            alert(
              "Konnte die TXT nicht laden.\n" +
                "Tipp: Seite über http://localhost testen oder später auf GitHub Pages ausführen.\n\nFehler: " +
                e.message
            );
          }
        });

        btnCancel?.addEventListener("click", () => {
          showView();
        });

        btnSave?.addEventListener("click", () => {
          const blob = new Blob([editor.value], {
            type: "text/plain;charset=utf-8",
          });
          const url = URL.createObjectURL(blob);
          btnSave.href = url;
          setTimeout(() => URL.revokeObjectURL(url), 30000);
        });

        // PDF-Generierung (Druckansicht → "Als PDF speichern")
        btnPdf?.addEventListener("click", async () => {
          try {
            const text =
              editor.style.display !== "none" && editor.value?.length
                ? editor.value
                : await loadText(filePath);
            openPrintView(text);
          } catch (e) {
            alert("PDF-Ansicht konnte nicht erstellt werden:\n" + e.message);
          }
        });

        function openPrintView(rawText) {
          const css = `
            @page { margin: 16mm; }
            body { font: 12px/1.45 ui-monospace, Menlo, Consolas, monospace; color:#000; }
            h1 { font: 700 16px/1.2 system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0 0 8px; }
            .meta { color:#444; font: 12px system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0 0 12px; }
            pre { white-space: pre-wrap; word-wrap: break-word; }
            .box { border:1px solid #ccc; padding:10px; border-radius:8px; background:#f7f7f7; }
          `;
          const title =
            document.querySelector(".title")?.textContent?.trim() ||
            "Birkenbihl-Text";
          const win = window.open("", "_blank");
          if (!win) throw new Error("Popup blockiert. Bitte Popups erlauben.");

          win.document.open();
          win.document.write(`<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)} – PDF</title>
<style>${css}</style>
</head>
<body>
  <h1>${escapeHtml(title)} – PDF-Export</h1>
  <div class="meta">
    Quelle: aktuelle Birkenbihl-TXT (diese Seite) · Erzeugt: ${new Date().toLocaleString()}
  </div>
  <div class="box">
    <pre>${escapeHtml(rawText)}</pre>
  </div>
  <script>
    window.onload = function(){ window.print(); };
  <\/script>
</body>
</html>`);
          win.document.close();
        }

        function escapeHtml(s) {
          return (s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }
      })();
    </script>
    <!-- ######## ENDE: Skript – Bearbeiten + PDF ######## -->
  </body>
</html>
